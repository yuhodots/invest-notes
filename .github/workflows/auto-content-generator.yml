name: Auto Content Generator

on:
  issues:
    types: [opened]

jobs:
  generate-content:
    if: contains(github.event.issue.labels.*.name, 'content-request')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: Install dependencies
      run: |
        cd ai_workflows
        uv sync --locked
    
    - name: Extract issue information
      id: issue-info
      run: |
        echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
        echo "ISSUE_BODY=${{ github.event.issue.body }}" >> $GITHUB_ENV
        echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV
        
        # Create slug from issue title
        SLUG=$(echo "${{ github.event.issue.title }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9ê°€-í£]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
        echo "SLUG=$SLUG" >> $GITHUB_ENV
        
        # Get current date
        DATE=$(date +%Y-%m-%d)
        echo "DATE=$DATE" >> $GITHUB_ENV
    
    - name: Generate Korean content
      run: |
        cd ai_workflows
        uv run python writer.py \
          --title "${{ env.ISSUE_TITLE }}" \
          --body "${{ env.ISSUE_BODY }}" \
          --output "../contents/kor/${{ env.DATE }}-${{ env.SLUG }}.md" \
          --language "korean"
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    
    - name: Generate English content
      run: |
        cd ai_workflows
        uv run python translator.py \
          --input "../contents/kor/${{ env.DATE }}-${{ env.SLUG }}.md" \
          --output "../contents/eng/${{ env.DATE }}-${{ env.SLUG }}.md"
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          feat: auto-generated content for issue #${{ env.ISSUE_NUMBER }}
          
          - Generated Korean content: ${{ env.DATE }}-${{ env.SLUG }}.md
          - Generated English content: ${{ env.DATE }}-${{ env.SLUG }}.md
          
          Based on issue: ${{ env.ISSUE_TITLE }}
        title: "Auto-generated content: ${{ env.ISSUE_TITLE }}"
        body: |
          ## ìë™ ìƒì„±ëœ ì»¨í…ì¸ 
          
          ì´ PRì€ ì´ìŠˆ #${{ env.ISSUE_NUMBER }}ì— ëŒ€í•œ ì‘ë‹µìœ¼ë¡œ AIê°€ ìë™ ìƒì„±í•œ ì»¨í…ì¸ ì…ë‹ˆë‹¤.
          
          ### ìƒì„±ëœ íŒŒì¼ë“¤:
          - ğŸ“ í•œêµ­ì–´: `contents/kor/${{ env.DATE }}-${{ env.SLUG }}.md`
          - ğŸ“ ì˜ì–´: `contents/eng/${{ env.DATE }}-${{ env.SLUG }}.md`
          
          ### ì›ë³¸ ì´ìŠˆ:
          **ì œëª©:** ${{ env.ISSUE_TITLE }}
          
          **ë§í¬:** #${{ env.ISSUE_NUMBER }}
          
          ---
          
          âœ… ê²€í†  í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”.
          âŒ ë¬¸ì œê°€ ìˆë‹¤ë©´ ì´ìŠˆë¥¼ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
        branch: auto-content/${{ env.ISSUE_NUMBER }}-${{ env.SLUG }}
        labels: |
          auto-generated
          content
        reviewers: |
          ${{ github.event.issue.user.login }}
    
    - name: Add comment to issue
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸ¤– **ì»¨í…ì¸  ìƒì„± ì™„ë£Œ!**
            
            ê·€í•˜ì˜ ìš”ì²­ì— ë”°ë¼ AIê°€ ì»¨í…ì¸ ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤.
            
            ğŸ“‹ **ìƒì„±ëœ íŒŒì¼ë“¤:**
            - í•œêµ­ì–´: \`contents/kor/${{ env.DATE }}-${{ env.SLUG }}.md\`
            - ì˜ì–´: \`contents/eng/${{ env.DATE }}-${{ env.SLUG }}.md\`
            
            ğŸ” **ë‹¤ìŒ ë‹¨ê³„:**
            PRì„ í™•ì¸í•˜ê³  ê²€í† í•´ì£¼ì„¸ìš”. ë¬¸ì œê°€ ì—†ìœ¼ë©´ ë¨¸ì§€í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
            
            âœ¨ ìƒì„±ëœ PR: [Auto-generated content: ${{ env.ISSUE_TITLE }}]`
          })
    
    - name: Add labels to issue
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['auto-processed', 'completed']
          })